# ---------------------------------------------------------------
# ArgoCD ApplicationSet — Branch-based deployment
# Two long-lived branches map to exactly one environment each:
#   dev branch  → dex-dev  (development)
#   main branch → dex      (production)
# Co-located in same DEX repo (infra/argocd/overlays/)
# ---------------------------------------------------------------
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: dex-environments
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          - name: dex-dev
            namespace: dex-dev
            environment: dev
            branch: dev
          - name: dex
            namespace: dex
            environment: prod
            branch: main
  template:
    metadata:
      name: "{{name}}"
      namespace: argocd
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: dex-project
      source:
        repoURL: https://github.com/TheDataEngineX/DEX
        targetRevision: "{{branch}}"
        path: "infra/argocd/overlays/{{environment}}"
      destination:
        server: https://kubernetes.default.svc
        namespace: "{{namespace}}"
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m

---
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: dex-project
  namespace: argocd
spec:
  description: DEX - DataEngineX Project

  sourceRepos:
    - 'https://github.com/TheDataEngineX/DEX'

  destinations:
    - namespace: 'dex'
      server: https://kubernetes.default.svc
    - namespace: 'dex-dev'
      server: https://kubernetes.default.svc

  clusterResourceWhitelist:
    - group: ''
      kind: Namespace
