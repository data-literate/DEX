[tool.poe]
executor.type = "uv"

# Installation & Setup
[tool.poe.tasks.install]
shell = "uv sync && uvx pre-commit install"
help = "Install dependencies and pre-commit hooks"

[tool.poe.tasks.setup]
shell = "uv sync --all-groups && uvx pre-commit install"
help = "One-step setup: install all dependency groups and pre-commit hooks"

# Development
[tool.poe.tasks.dev]
cmd = "uvicorn careerdex.api.main:app --reload --port 8000"
help = "Run development server on localhost:8000"

# Testing
[tool.poe.tasks.test-core]
cmd = "pytest tests/ -v --tb=short"
help = "Internal: run all tests without dependency sync"

[tool.poe.tasks.test-unit-core]
cmd = "pytest tests/unit/ -v --tb=short"
help = "Internal: run unit tests without dependency sync"

[tool.poe.tasks.test-integration-core]
cmd = "pytest tests/integration/ -v --tb=short"
help = "Internal: run integration tests without dependency sync"

[tool.poe.tasks.test-cov-core]
cmd = "pytest tests/ -v --cov=dataenginex --cov=careerdex --cov=weatherdex --cov-report=html --cov-report=xml:coverage.xml --cov-report=term-missing"
help = "Internal: run coverage tests without dependency sync"

[tool.poe.tasks.test]
shell = "poe uv-sync && poe test-core"
help = "Run all tests"

[tool.poe.tasks.test-unit]
shell = "poe uv-sync && poe test-unit-core"
help = "Run unit tests only"

[tool.poe.tasks.test-integration]
shell = "poe uv-sync && poe test-integration-core"
help = "Run integration tests only"

[tool.poe.tasks.test-cov]
shell = "poe uv-sync && poe test-cov-core"
help = "Run tests with coverage report (HTML + XML + terminal)"

# Code Quality
[tool.poe.tasks.lint]
shell = "ruff check src/ packages/dataenginex/src/ tests/"
help = "Run ruff lint on source and test files"

[tool.poe.tasks.imports-check]
shell = "ruff check --select I src/ packages/dataenginex/src/ tests/"
help = "Enforce import sorting/formatting (Ruff I rules)"

[tool.poe.tasks.lint-fix]
shell = "ruff check --fix src/ packages/dataenginex/src/ tests/ && ruff format src/ packages/dataenginex/src/ tests/"
help = "Auto-fix lint issues and format code"

[tool.poe.tasks.format]
shell = "ruff format src/ packages/dataenginex/src/ tests/"
help = "Format code with ruff"

[tool.poe.tasks.typecheck]
cmd = "mypy packages/dataenginex/src/dataenginex/ --config-file=pyproject.toml --no-incremental"
help = "Run mypy type checking with project config"
env = { UV_PYTHON = "3.11", UV_PROJECT_ENVIRONMENT = ".venv" }

[tool.poe.tasks.security]
cmd = "uvx pip-audit --progress-spinner off"
help = "Audit dependencies for known vulnerabilities (tool-style via uvx)"

[tool.poe.tasks.pre-commit]
cmd = "uvx pre-commit run --all-files"
help = "Run all pre-commit hooks"

[tool.poe.tasks.actionlint]
shell = "if command -v actionlint >/dev/null 2>&1; then actionlint .github/workflows/*.yml; elif command -v docker >/dev/null 2>&1; then docker run --rm -v \"$PWD\":/repo -w /repo rhysd/actionlint:latest actionlint .github/workflows/*.yml; else echo 'actionlint not found. Install actionlint locally or install Docker for container fallback.'; exit 127; fi"
help = "Lint GitHub Actions workflows (local actionlint or Docker fallback)"

[tool.poe.tasks.check-all-core]
shell = "poe pre-commit && poe test-core && poe actionlint && poe docs"
help = "Internal: run full project checks without dependency sync"

[tool.poe.tasks.check-all]
shell = "poe uv-sync && poe check-all-core"
help = "Run full project checks: pre-commit hooks, tests, workflow lint, and docs build"

[tool.poe.tasks.clean]
shell = "find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null; find . -type f -name '*.pyc' -delete 2>/dev/null; rm -rf .pytest_cache .mypy_cache .ruff_cache dist build *.egg-info 2>/dev/null; echo 'Cache and artifacts cleaned'"
help = "Remove cache and build artifacts"

# Docker
[tool.poe.tasks.docker-build]
cmd = "docker build -t dex:latest ."
help = "Build Docker image"

[tool.poe.tasks.docker-up]
cmd = "docker compose up -d"
help = "Start services with Docker Compose"

[tool.poe.tasks.docker-down]
cmd = "docker compose down"
help = "Stop Docker Compose services"

[tool.poe.tasks.docker-logs]
cmd = "docker compose logs -f"
help = "View Docker Compose logs"

# Kubernetes
[tool.poe.tasks.k8s-deploy]
cmd = "kubectl apply -k infra/argocd/base/"
help = "Deploy to Kubernetes via Kustomize"

[tool.poe.tasks.k8s-delete]
cmd = "kubectl delete -k infra/argocd/base/"
help = "Delete Kubernetes resources"

# Documentation
[tool.poe.tasks.docs]
shell = "zensical build --clean && echo 'Documentation built. Open site/index.html'"
help = "Build documentation site with Zensical"

# Version
[tool.poe.tasks.version]
shell = "grep version pyproject.toml | head -1"
help = "Show project version"

# Weather Pipeline Tasks
[tool.poe.tasks.weather-feature]
cmd = "python src/weatherdex/notebooks/feature_engineering.py"
help = "Run weather feature engineering pipeline"

[tool.poe.tasks.weather-train]
cmd = "python src/weatherdex/notebooks/train_model.py"
help = "Train weather models"

[tool.poe.tasks.weather-analyze]
cmd = "python src/weatherdex/notebooks/analyze_predictions.py"
help = "Analyze weather model predictions"

# UV Package Manager
[tool.poe.tasks.uv]
cmd = "uv"
help = "Launch the Astral uv CLI"

[tool.poe.tasks.uv-lock]
cmd = "uv lock"
help = "Resolve dependencies from pyproject.toml and write uv.lock"

[tool.poe.tasks.uv-sync]
cmd = "uv sync"
help = "Install dependencies from uv.lock"
env = { UV_PROJECT_ENVIRONMENT = ".venv" }

[tool.poe.tasks.uv-sync-all]
cmd = "uv sync --all-groups"
help = "Install dependencies from uv.lock for all groups"
env = { UV_PROJECT_ENVIRONMENT = ".venv" }

[tool.poe.tasks.check-all-managed]
shell = "status=0; poe uv-sync-all || status=$?; if [ $status -eq 0 ]; then poe check-all-core || status=$?; fi; poe clean; exit $status"
help = "Run dependency sync, full checks, then cleanup (cleanup always runs)"
