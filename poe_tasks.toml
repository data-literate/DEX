[tool.poe]
executor.type = "uv"

# Installation & Setup
[tool.poe.tasks.install]
shell = "uv sync && pre-commit install"
help = "Install dependencies and pre-commit hooks"

# Development
[tool.poe.tasks.dev]
cmd = "uvicorn careerdex.api.main:app --reload --port 8000"
help = "Run development server on localhost:8000"

# Testing
[tool.poe.tasks.test]
cmd = "pytest tests/ -v --tb=short"
help = "Run all tests"

[tool.poe.tasks.test-unit]
cmd = "pytest tests/unit/ -v --tb=short"
help = "Run unit tests only"

[tool.poe.tasks.test-integration]
cmd = "pytest tests/integration/ -v --tb=short"
help = "Run integration tests only"

[tool.poe.tasks.test-cov]
cmd = "pytest tests/ -v --cov=dataenginex --cov=careerdex --cov=weatherdex --cov-report=html --cov-report=xml:coverage.xml --cov-report=term-missing"
help = "Run tests with coverage report (HTML + XML + terminal)"

# Code Quality
[tool.poe.tasks.lint]
shell = "ruff check src/ packages/dataenginex/src/ tests/"
help = "Run ruff lint on source and test files"

[tool.poe.tasks.imports-check]
shell = "ruff check --select I src/ packages/dataenginex/src/ tests/"
help = "Enforce import sorting/formatting (Ruff I rules)"

[tool.poe.tasks.lint-fix]
shell = "ruff check --fix src/ packages/dataenginex/src/ tests/ && ruff format src/ packages/dataenginex/src/ tests/"
help = "Auto-fix lint issues and format code"

[tool.poe.tasks.format]
shell = "ruff format src/ packages/dataenginex/src/ tests/"
help = "Format code with ruff"

[tool.poe.tasks.typecheck]
cmd = "mypy packages/dataenginex/src/dataenginex/ --config-file=pyproject.toml --no-incremental"
help = "Run mypy type checking with project config"
env = { UV_PYTHON = "3.11", UV_PROJECT_ENVIRONMENT = ".venv" }

[tool.poe.tasks.security]
shell = "pip-audit --progress-spinner off 2>&1 || echo 'pip-audit not installed â€” run: uv pip install pip-audit'"
help = "Audit dependencies for known vulnerabilities"

[tool.poe.tasks.pre-commit]
cmd = "pre-commit run --all-files"
help = "Run all pre-commit hooks"

[tool.poe.tasks.actionlint]
cmd = "actionlint .github/workflows/*.yml"
help = "Lint GitHub Actions workflows"

[tool.poe.tasks.check-all]
shell = "poe imports-check && poe lint && poe typecheck && poe test"
help = "Run import-order check, lint, typecheck, and tests in sequence"

[tool.poe.tasks.clean]
shell = "find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null; find . -type f -name '*.pyc' -delete 2>/dev/null; rm -rf .pytest_cache .mypy_cache .ruff_cache dist build *.egg-info 2>/dev/null; echo 'Cache and artifacts cleaned'"
help = "Remove cache and build artifacts"

# Docker
[tool.poe.tasks.docker-build]
cmd = "docker build -t dex:latest ."
help = "Build Docker image"

[tool.poe.tasks.docker-up]
cmd = "docker compose up -d"
help = "Start services with Docker Compose"

[tool.poe.tasks.docker-down]
cmd = "docker compose down"
help = "Stop Docker Compose services"

[tool.poe.tasks.docker-logs]
cmd = "docker compose logs -f"
help = "View Docker Compose logs"

# Kubernetes
[tool.poe.tasks.k8s-deploy]
cmd = "kubectl apply -k infra/argocd/base/"
help = "Deploy to Kubernetes via Kustomize"

[tool.poe.tasks.k8s-delete]
cmd = "kubectl delete -k infra/argocd/base/"
help = "Delete Kubernetes resources"

# Documentation
[tool.poe.tasks.docs]
shell = "cd docs && sphinx-build -b html . _build/html && echo 'Documentation built. Open docs/_build/html/index.html'"
help = "Generate and serve documentation"

# Version
[tool.poe.tasks.version]
shell = "grep version pyproject.toml | head -1"
help = "Show project version"

# Weather Pipeline Tasks
[tool.poe.tasks.weather-feature]
cmd = "python src/weatherdex/notebooks/feature_engineering.py"
help = "Run weather feature engineering pipeline"

[tool.poe.tasks.weather-train]
cmd = "python src/weatherdex/notebooks/train_model.py"
help = "Train weather models"

[tool.poe.tasks.weather-analyze]
cmd = "python src/weatherdex/notebooks/analyze_predictions.py"
help = "Analyze weather model predictions"

# UV Package Manager
[tool.poe.tasks.uv]
cmd = "uv"
help = "Launch the Astral uv CLI"

[tool.poe.tasks.uv-lock]
cmd = "uv lock"
help = "Resolve dependencies from pyproject.toml and write uv.lock"

[tool.poe.tasks.uv-sync]
cmd = "uv sync"
help = "Install dependencies from uv.lock"
env = { UV_PROJECT_ENVIRONMENT = ".venv" }
