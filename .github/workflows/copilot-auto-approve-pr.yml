name: Copilot Auto-Approve PR

on:
  pull_request:
    types: [opened, synchronize]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: write

jobs:
  request-copilot-review:
    name: Request Copilot Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Request review from Copilot
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            console.log(`Requesting Copilot review for PR #${pr.number}`);
            
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                reviewers: ['copilot-pull-request-reviewer']
              });
              console.log('✓ Copilot review requested successfully');
            } catch (error) {
              console.log(`Note: ${error.message}`);
              console.log('Copilot reviews are automatic, no manual request needed');
            }

  auto-approve:
    name: Auto-Approve if Copilot Satisfied
    runs-on: ubuntu-latest
    # Only run if the review is from Copilot
    if: github.event_name == 'pull_request_review' && github.event.review.user.login == 'copilot-pull-request-reviewer'
    
    steps:
      - name: Check Copilot Review and Auto-Approve
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const review = context.payload.review;
            
            console.log(`Copilot review submitted for PR #${pr.number}`);
            console.log(`Review body: ${review.body.substring(0, 200)}...`);
            
            // Check if Copilot's review indicates no new comments
            const hasNoNewComments = review.body.includes('generated no new comments') || 
                                     review.body.includes('generated 0 comments');
            
            // Check if PR is from repository owner
            const isOwner = pr.user.login === context.repo.owner;
            
            console.log(`Has no new comments: ${hasNoNewComments}`);
            console.log(`PR from owner: ${isOwner} (${pr.user.login})`);
            
            if (isOwner && hasNoNewComments) {
              console.log('✓ Auto-approving PR: Owner + Copilot satisfied (no new comments)');
              
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                event: 'APPROVE',
                body: '✅ Auto-approved: Copilot review completed with no new comments.'
              });
              
              console.log('✓ Approval submitted successfully');
            } else {
              console.log(`✗ Skipping approval:`);
              console.log(`  - PR from owner: ${isOwner}`);
              console.log(`  - Copilot satisfied: ${hasNoNewComments}`);
            }
