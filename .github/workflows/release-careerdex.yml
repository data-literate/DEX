# CareerDEX Release Automation
# Triggered when root pyproject.toml version changes.
# Creates git tag + GitHub release for the CareerDEX app.

name: Release CareerDEX

on:
  push:
    branches:
      - main
    paths:
      - 'pyproject.toml'

permissions:
  contents: write
  packages: read

env:
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

jobs:
  release-careerdex:
    name: Release CareerDEX App
    runs-on: ubuntu-latest
    if: github.event.repository.default_branch == github.ref_name

    steps:
      - name: Notify Release Start
        uses: actions/github-script@v8
        if: always()
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) return;
            try {
              await fetch(process.env.SLACK_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: 'üíº CareerDEX App Release Started',
                  blocks: [{
                    type: 'section',
                    text: {
                      type: 'mrkdwn',
                      text: `*üíº CareerDEX Release Process Started*\n*Job Matching Application*\n*Branch:* main`
                    }
                  }]
                })
              });
            } catch (e) { console.log('Slack notification failed'); }
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract CareerDEX version
        id: version
        run: |
          VERSION=$(grep -m 1 "^version = " pyproject.toml | sed 's/version = "//;s/".*//')
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid root project version in pyproject.toml: $VERSION"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=careerdex-v$VERSION" >> "$GITHUB_OUTPUT"
          echo "Extracted CareerDEX version: $VERSION"

      - name: Check if tag already exists
        id: check_tag
        run: |
          if git rev-parse "${{ steps.version.outputs.tag }}" >/dev/null 2>&1; then
            echo "tag_exists=true" >> "$GITHUB_OUTPUT"
            echo "Tag ${{ steps.version.outputs.tag }} already exists"
          else
            echo "tag_exists=false" >> "$GITHUB_OUTPUT"
            echo "Tag ${{ steps.version.outputs.tag }} is new"
          fi

      - name: Configure git
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create git tag
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: |
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release CareerDEX ${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Create GitHub Release
        if: steps.check_tag.outputs.tag_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --target main \
            --title "CareerDEX ${{ steps.version.outputs.tag }}" \
            --notes "CareerDEX application release. See docs/careerdex/README.md for details." \
            --generate-notes \
            --draft=false

      - name: Notify Release Success
        if: success() && steps.check_tag.outputs.tag_exists == 'false'
        uses: actions/github-script@v8
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) return;
            try {
              await fetch(process.env.SLACK_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: '‚úÖ CareerDEX App Released',
                  blocks: [{
                    type: 'section',
                    text: {
                      type: 'mrkdwn',
                      text: `*‚úÖ CareerDEX Release Created*\n*Job Matching Application*\n*Version:* ${process.env.VERSION}\n*Tag:* ${process.env.TAG}\n*Release:* <${process.env.URL}|View Release>`
                    }
                  }]
                })
              });
            } catch (e) { console.log('Slack notification failed'); }
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}
          VERSION: ${{ steps.version.outputs.version }}
          TAG: ${{ steps.version.outputs.tag }}
          URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}

      - name: Notify Release Failure
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) return;
            try {
              await fetch(process.env.SLACK_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: '‚ùå CareerDEX Release Failed',
                  blocks: [
                    {
                      type: 'section',
                      text: {
                        type: 'mrkdwn',
                        text: `*‚ùå CareerDEX Release Failed*`
                      }
                    },
                    {
                      type: 'section',
                      fields: [
                        { type: 'mrkdwn', text: `*Workflow:*\nCareerDEX Release` },
                        { type: 'mrkdwn', text: `*Branch:*\nmain` },
                        { type: 'mrkdwn', text: `*Commit:*\n\`${process.env.SHA?.substring(0, 8)}\`` },
                        { type: 'mrkdwn', text: `*Triggered by:*\n${process.env.ACTOR}` },
                        { type: 'mrkdwn', text: `*Run:*\n<${process.env.URL}|View Details>` }
                      ]
                    },
                    {
                      type: 'context',
                      elements: [{ type: 'mrkdwn', text: `üè∑Ô∏è CareerDEX release tag creation failed ‚Äî check logs` }]
                    }
                  ]
                })
              });
            } catch (e) { console.log('Slack notification failed:', e.message); }
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}
          SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
