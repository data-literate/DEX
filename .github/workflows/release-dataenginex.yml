# DataEngineX Release Automation
# Triggered when packages/dataenginex/pyproject.toml version changes.
# Creates git tag + GitHub release, which triggers pypi-publish.yml.

name: Release DataEngineX

on:
  push:
    branches:
      - main
    paths:
      - 'packages/dataenginex/pyproject.toml'

permissions:
  contents: write
  packages: read

env:
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

jobs:
  release-dataenginex:
    name: Release DataEngineX Package
    runs-on: ubuntu-latest
    if: github.event.repository.default_branch == github.ref_name

    steps:
      - name: Notify Release Start
        uses: actions/github-script@v8
        if: always()
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) return;
            try {
              await fetch(process.env.SLACK_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: 'üíé DataEngineX Core Package Release Started',
                  blocks: [{
                    type: 'section',
                    text: {
                      type: 'mrkdwn',
                      text: `*üíé DataEngineX Release Process Started*\n*Core Package Library for PyPI*\n*Branch:* main`
                    }
                  }]
                })
              });
            } catch (e) { console.log('Slack notification failed'); }
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract DataEngineX version
        id: version
        run: |
          VERSION=$(grep -m 1 "^version = " packages/dataenginex/pyproject.toml | sed 's/version = "//;s/".*//')
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid DataEngineX version in packages/dataenginex/pyproject.toml: $VERSION"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=dataenginex-v$VERSION" >> "$GITHUB_OUTPUT"
          echo "Extracted DataEngineX version: $VERSION"

      - name: Extract DataEngineX changelog notes
        id: changelog
        run: |
          CHANGELOG="packages/dataenginex/CHANGELOG.md"
          if [[ -f "$CHANGELOG" ]]; then
            NOTES=$(awk "/^## \\[${{ steps.version.outputs.version }}\\]/{found=1; next} /^## \\[/{if(found) exit} found" "$CHANGELOG")
            if [[ -z "$NOTES" ]]; then
              NOTES="DataEngineX v${{ steps.version.outputs.version }} ‚Äî see CHANGELOG.md for details."
            fi
          else
            NOTES="DataEngineX v${{ steps.version.outputs.version }} ‚Äî see RELEASE_NOTES.md for details."
          fi
          {
            echo "notes<<CHANGELOG_EOF"
            echo "$NOTES"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Check if tag already exists
        id: check_tag
        run: |
          if git rev-parse "${{ steps.version.outputs.tag }}" >/dev/null 2>&1; then
            echo "tag_exists=true" >> "$GITHUB_OUTPUT"
            echo "Tag ${{ steps.version.outputs.tag }} already exists"
          else
            echo "tag_exists=false" >> "$GITHUB_OUTPUT"
            echo "Tag ${{ steps.version.outputs.tag }} is new"
          fi

      - name: Configure git
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create git tag
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: |
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release DataEngineX ${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Create GitHub Release
        if: steps.check_tag.outputs.tag_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --target main \
            --title "DataEngineX ${{ steps.version.outputs.tag }}" \
            --notes "${{ steps.changelog.outputs.notes }}" \
            --generate-notes \
            --draft=false

      - name: Notify Release Success
        if: success() && steps.check_tag.outputs.tag_exists == 'false'
        uses: actions/github-script@v8
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) return;
            try {
              await fetch(process.env.SLACK_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: '‚úÖ DataEngineX Core Package Released',
                  blocks: [{
                    type: 'section',
                    text: {
                      type: 'mrkdwn',
                      text: `*‚úÖ DataEngineX Release Created*\n*Core Package Library*\n*Version:* ${process.env.VERSION}\n*Tag:* ${process.env.TAG}\n*Release:* <${process.env.URL}|View Release>`
                    }
                  }]
                })
              });
            } catch (e) { console.log('Slack notification failed'); }
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}
          VERSION: ${{ steps.version.outputs.version }}
          TAG: ${{ steps.version.outputs.tag }}
          URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}

      - name: Notify Release Failure
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) return;
            try {
              await fetch(process.env.SLACK_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: '‚ùå DataEngineX Release Failed',
                  blocks: [
                    {
                      type: 'section',
                      text: {
                        type: 'mrkdwn',
                        text: `*‚ùå DataEngineX Release Failed*`
                      }
                    },
                    {
                      type: 'section',
                      fields: [
                        { type: 'mrkdwn', text: `*Workflow:*\nDataEngineX Release` },
                        { type: 'mrkdwn', text: `*Branch:*\nmain` },
                        { type: 'mrkdwn', text: `*Commit:*\n\`${process.env.SHA?.substring(0, 8)}\`` },
                        { type: 'mrkdwn', text: `*Triggered by:*\n${process.env.ACTOR}` },
                        { type: 'mrkdwn', text: `*Run:*\n<${process.env.URL}|View Details>` }
                      ]
                    },
                    {
                      type: 'context',
                      elements: [{ type: 'mrkdwn', text: `üè∑Ô∏è DataEngineX release tag creation failed ‚Äî check logs` }]
                    }
                  ]
                })
              });
            } catch (e) { console.log('Slack notification failed:', e.message); }
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}
          SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
