name: Release

on:
  push:
    branches:
      - main
    paths:
      - 'pyproject.toml'

permissions:
  contents: write
  packages: read

env:
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

jobs:
  release:
    name: Version-Based Release
    runs-on: ubuntu-latest
    if: github.event.repository.default_branch == github.ref_name

    steps:
      - name: Notify Release Start
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) return;
            try {
              await fetch(process.env.SLACK_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: 'üéâ Release Process Started',
                  blocks: [{
                    type: 'section',
                    text: {
                      type: 'mrkdwn',
                      text: `*üéâ Release Process Started*\n*Branch:* main`
                    }
                  }]
                })
              });
            } catch (e) { console.log('Slack notification failed'); }
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep -m 1 "^version = " pyproject.toml | sed 's/version = "//;s/".*//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Extract changelog notes
        id: changelog
        run: |
          CHANGELOG="packages/dataenginex/CHANGELOG.md"
          if [[ -f "$CHANGELOG" ]]; then
            # Extract the section for this version (between two ## headers)
            NOTES=$(awk "/^## \\[${{ steps.version.outputs.version }}\\]/{found=1; next} /^## \\[/{if(found) exit} found" "$CHANGELOG")
            if [[ -z "$NOTES" ]]; then
              NOTES="Version ${{ steps.version.outputs.version }} ‚Äî see CHANGELOG.md for details."
            fi
          else
            NOTES="Version ${{ steps.version.outputs.version }} ‚Äî see RELEASE_NOTES.md for details."
          fi
          # Write multiline output
          {
            echo "notes<<CHANGELOG_EOF"
            echo "$NOTES"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Check if tag already exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            echo "Tag v${{ steps.version.outputs.version }} already exists"
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
            echo "Tag v${{ steps.version.outputs.version }} is new"
          fi

      - name: Configure git
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create git tag
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: |
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Create GitHub Release
        if: steps.check_tag.outputs.tag_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --target main \
            --title "Release ${{ steps.version.outputs.tag }}" \
            --notes "${{ steps.changelog.outputs.notes }}" \
            --draft=false

      - name: Notify Release Success
        if: success() && steps.check_tag.outputs.tag_exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) return;
            try {
              await fetch(process.env.SLACK_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: '‚úÖ Release Created Successfully',
                  blocks: [{
                    type: 'section',
                    text: {
                      type: 'mrkdwn',
                      text: `*‚úÖ Release Created*\n*Version:* ${process.env.VERSION}\n*Tag:* ${process.env.TAG}\n*Release:* <${process.env.URL}|View Release>`
                    }
                  }]
                })
              });
            } catch (e) { console.log('Slack notification failed'); }
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}
          VERSION: ${{ steps.version.outputs.version }}
          TAG: ${{ steps.version.outputs.tag }}
          URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}

      - name: Notify Release Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) return;
            try {
              await fetch(process.env.SLACK_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: '‚ùå Release Process Failed',
                  blocks: [
                    {
                      type: 'section',
                      text: {
                        type: 'mrkdwn',
                        text: `*‚ùå Release Process Failed*`
                      }
                    },
                    {
                      type: 'section',
                      fields: [
                        { type: 'mrkdwn', text: `*Workflow:*\nRelease` },
                        { type: 'mrkdwn', text: `*Branch:*\nmain` },
                        { type: 'mrkdwn', text: `*Commit:*\n\`${process.env.SHA?.substring(0, 8)}\`` },
                        { type: 'mrkdwn', text: `*Triggered by:*\n${process.env.ACTOR}` },
                        { type: 'mrkdwn', text: `*Run:*\n<${process.env.URL}|View Details>` }
                      ]
                    },
                    {
                      type: 'context',
                      elements: [{ type: 'mrkdwn', text: `üè∑Ô∏è Release tag creation or GitHub Release failed ‚Äî check logs` }]
                    }
                  ]
                })
              });
            } catch (e) { console.log('Slack notification failed:', e.message); }
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}
          SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
