# DataEngineX Package Validation
# Specific to the core package (packages/dataenginex/).
# Validates that the pyproject.toml builds a valid wheel + passes twine checks.
# CareerDEX app (src/careerdex/) is tested in ci.yml as an integrated app.

name: Package Validation

on:
  pull_request:
    branches:
      - main
      - dev
    paths:
      - 'packages/dataenginex/**'
      - 'packages/**'
      - '.github/workflows/package-validation.yml'
  push:
    branches:
      - main
      - dev

permissions:
  contents: read

env:
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

jobs:
  validate-dataenginex-package:
    name: Validate dataenginex Package
    runs-on: ubuntu-latest

    steps:
      - name: Notify Package Validation Start
        uses: actions/github-script@v8
        if: always()
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) return;
            try {
              await fetch(process.env.SLACK_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: 'üì¶ Package Validation Started',
                  blocks: [{
                    type: 'section',
                    text: {
                      type: 'mrkdwn',
                      text: `*üì¶ Package Validation Started*\n*Building & Validating Package Distributions*\n*Event:* ${process.env.EVENT}\n*Branch:* ${process.env.REF}\n*By:* ${process.env.ACTOR}`
                    }
                  }]
                })
              });
            } catch (e) { console.log('Slack notification failed'); }
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}
          EVENT: ${{ github.event_name }}
          REF: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Build and validate dataenginex
        run: |
          cd packages/dataenginex
          uvx --from build pyproject-build
          uvx twine check dist/*

      - name: Notify Package Validation Success
        if: success()
        uses: actions/github-script@v8
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) return;
            try {
              await fetch(process.env.SLACK_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: '‚úÖ Package Valid',
                  blocks: [{
                    type: 'section',
                    text: {
                      type: 'mrkdwn',
                      text: `*‚úÖ Package Validation Passed*\n*Distribution builds successfully*\n*Branch:* ${process.env.REF}\n*By:* ${process.env.ACTOR}`
                    }
                  }]
                })
              });
            } catch (e) { console.log('Slack notification failed'); }
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}
          REF: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}

      - name: Notify Package Validation Failure
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) return;
            try {
              await fetch(process.env.SLACK_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: '‚ùå Package Validation Failed',
                  blocks: [
                    {
                      type: 'section',
                      text: {
                        type: 'mrkdwn',
                        text: `*‚ùå Package Validation Failed*\n‚ö†Ô∏è Distribution build or twine checks failed`
                      }
                    },
                    {
                      type: 'section',
                      fields: [
                        { type: 'mrkdwn', text: `*Branch:*\n${process.env.REF}` },
                        { type: 'mrkdwn', text: `*Triggered by:*\n${process.env.ACTOR}` },
                        { type: 'mrkdwn', text: `*Event:*\n${process.env.EVENT}` },
                        { type: 'mrkdwn', text: `*Run:*\n<${process.env.URL}|View Details>` }
                      ]
                    }
                  ]
                })
              });
            } catch (e) { console.log('Slack notification failed:', e.message); }
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}
          REF: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          EVENT: ${{ github.event_name }}
          URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
